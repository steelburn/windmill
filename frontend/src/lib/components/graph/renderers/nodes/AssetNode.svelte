<script lang="ts">
	import NodeWrapper from './NodeWrapper.svelte'
	import type { AssetN } from '../../graphBuilder.svelte'
	import { AlertTriangle, Pyramid } from 'lucide-svelte'
	import { assetEq, formatAsset } from '$lib/components/assets/lib'
	import { twMerge } from 'tailwind-merge'
	import type { FlowGraphAssetContext } from '$lib/components/flows/types'
	import { getContext } from 'svelte'
	import ExploreAssetButton, {
		assetCanBeExplored
	} from '../../../../../routes/(root)/(logged)/assets/ExploreAssetButton.svelte'
	import { Tooltip } from '$lib/components/meltComponents'
	import { pluralize } from '$lib/utils'

	interface Props {
		data: AssetN['data']
	}

	const flowGraphAssetsCtx = getContext<FlowGraphAssetContext>('FlowGraphAssetContext')

	const usageCount = $derived(
		Object.values(flowGraphAssetsCtx.val.assetsMap ?? {})
			.flat()
			.filter((asset) => assetEq(asset, data.asset)).length
	)

	let { data }: Props = $props()
	const isSelected = $derived(assetEq(flowGraphAssetsCtx.val.selectedAsset, data.asset))
</script>

<NodeWrapper>
	{#snippet children({ darkMode })}
		<!-- svelte-ignore a11y_no_static_element_interactions -->
		<Tooltip>
			<div
				class={twMerge(
					'bg-surface h-6 flex items-center gap-1.5 rounded-sm text-tertiary border overflow-clip',
					isSelected ? 'bg-surface-secondary border-surface-inverse' : 'border-transparent'
				)}
				onmouseenter={() => (flowGraphAssetsCtx.val.selectedAsset = data.asset)}
				onmouseleave={() => (flowGraphAssetsCtx.val.selectedAsset = undefined)}
			>
				<Pyramid size={16} class="shrink-0 ml-1" />
				<span class="text-3xs truncate flex-1">
					{formatAsset(data.asset)}
				</span>
				{#if isSelected}
					{#if data.asset.kind === 'resource' && flowGraphAssetsCtx.val.resourceMetadataCache[data.asset.path] === undefined}
						<Tooltip class="mr-2.5">
							<AlertTriangle size={16} class="text-orange-500" />
							<svelte:fragment slot="text">Could not fetch resource</svelte:fragment>
						</Tooltip>
					{/if}
					{#if assetCanBeExplored(data.asset, flowGraphAssetsCtx.val.resourceMetadataCache[data.asset.path])}
						<ExploreAssetButton
							btnClasses="rounded-none"
							asset={data.asset}
							noText
							buttonVariant="contained"
							s3FilePicker={flowGraphAssetsCtx.val.s3FilePicker}
							dbManagerDrawer={flowGraphAssetsCtx.val.dbManagerDrawer}
							_resourceMetadata={flowGraphAssetsCtx.val.resourceMetadataCache[data.asset.path]}
						/>
					{/if}
				{/if}
			</div>
			<svelte:fragment slot="text">
				Used in {pluralize(usageCount, 'step')}<br />
				<a
					href={undefined}
					class={twMerge(
						'text-xs',
						data.asset.kind === 'resource'
							? 'text-blue-400 cursor-pointer'
							: 'dark:text-tertiary text-tertiary-inverse'
					)}
					onclick={() => {
						if (data.asset.kind === 'resource')
							flowGraphAssetsCtx.val.resourceEditorDrawer?.initEdit(data.asset.path)
					}}
				>
					{formatAsset(data.asset)}
				</a>
			</svelte:fragment>
		</Tooltip>
	{/snippet}
</NodeWrapper>
